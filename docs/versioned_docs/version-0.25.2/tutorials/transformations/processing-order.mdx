import ThemedImage from '@theme/ThemedImage';

# Processing order for objects

In many transformation use cases, you may wish to process objects in a particular order, depending on your application's data model and decisions you made around referential integrity. For example, you may want to process parent objects, like Accounts, before dependent objects, like Contacts, if you have foreign keys from Contacts to Accounts.

To help make this easier for you, Supaglue's [`sync.complete` webhook event](https://docs.supaglue.com/api/v2/mgmt/sync-complete) and [Management (Sync) API](https://docs.supaglue.com/api/v2/mgmt/get-syncs) provide information about whether related object Syncs have `finished` and their high-water mark.

## Related Sync States

The webhook and API endpoint above both provide a `related_sync_states` field that has information that looks like the following:

```json
"related_sync_states": {
    "account": {
        "object": "account",
        "object_type": "common",
        "strategy_type": "full then incremental",
        "finished": true,
        "synced_records_up_to_watermark": 1701728827881
    },
    "contact": {
        "object": "account",
        "object_type": "common",
        "strategy_type": "full then incremental",
        "finished": false,
        "synced_records_up_to_watermark": 1701728850969
    }
}
```

In this field, we provide you with two critical pieces of information: 

1. Whether the sync has finished at the point of Supaglue firing the webhook or you making the API call
2. The epoch Supaglue has finished syncing records up to (the high-water mark)

Using (1), you can determine when to proceed with processing Accounts and Contacts together by waiting for both objects to be in the `finished: true` state.

<ThemedImage
  alt="aggregate webhook event"
  width="75%"
  sources={{
    light: '/img/aggregate-webhook-event.png',
    dark: '/img/aggregate-webhook-event.png',
  }}
/>

Using (2), you can process up to the minimum of both objects' high-water marks.

## Webhook example

```typescript

const highWaterMarks = {
    contact: 0;
    account: 0;
}

router.post('/supaglue_webhook_endpoint', async (req: Request, res: Response) => {
    // validate webhook event

    // we only care about `sync.complete`; ignore the rest
    if (req.body.webhook_event_type !== 'sync.complete') {
        return res.status(200);
    }

    const areAccountAndContactSyncsFinished = req.body.related_sync_states.account.finished && req.body.related_sync_states.contact.finished;
    const isAccountOrContactSync = req.body.object === 'account' || req.body.object === 'contact';

    // ignore `sync.complete` events until both accounts and contacts finish
    if (!(isAccountOrContactSync && areAccountAndContactSyncsFinished)) {
        return res.status(200);

    }

    // only process up to the older of the two high-water marks
    const minOfBothHighWaterMark = Math.min(req.body.related_sync_states.account.synced_records_up_to_watermark, req.body.related_sync_states.contact.synced_records_up_to_watermark);

    // process accounts (see example below)
    // process contacts (see example below)

    highWaterMarks.account = minOfBothHighWaterMark;
    highWaterMarks.contact = minOfBothHighWaterMark;

    return res.status(200);
  });
```

### Managed Syncs example

Supaglue will continuously sync Accounts and Contacts into your database using Managed Syncs at the specified frequencies. Still, you can only process and set up foreign keys for records older than or equal to the `minOfBothHighWaterMark`.

To only show processed records, you could filter on `last_modified_at` or `_supaglue_last_modified_at` at query time using:

- A Postgres view
- An ORM query filter

### Listing API example

If you are syncing data and transforming it using Supaglue's Listing API, you can filter for records up to `minOfBothHighWaterMark` by passing the `modified_at` query parameter by converting epoch to ISO 8601.
